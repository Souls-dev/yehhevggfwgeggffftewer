-- Souls Hub: The Forge Ultimate Automation
local SoulsHub = loadstring(game:HttpGet("https://pandadevelopment.net/virtual/file/e7f388d3c065df7a"))()

task.wait(1)
SoulsHub:Loader(nil, 1).yield()

local FileWatcher = SoulsHub:ConfigManager({
    Directory = "SoulsHub",
    Config = "TheForge"
})

local Window = SoulsHub.new({
    Keybind = "LeftAlt",
})

local watermark = Window:Watermark()
watermark:AddText({
    Icon = "cog",
    Text = "The Forge"
})

local timeDisplay = watermark:AddText({
    Icon = "clock",
    Text = SoulsHub:GetTimeNow()
})

task.spawn(function()
    while true do
        task.wait()
        timeDisplay:SetText(SoulsHub:GetTimeNow())
    end
end)

Window:Update({
    ExpireDate = SoulsHub:GetDate(tick() + 86400)
})

watermark:AddText({
    Icon = "server",
    Text = "Active"
})

Window:DrawCategory({
    Name = "Automation"
})

local MainFarmTab = Window:DrawTab({
    Icon = "pickaxe",
    Name = "Main Farm"
})

local AutoForgeTab = Window:DrawTab({
    Icon = "hammer",
    Name = "Auto Forge"
})

local AutoTab = Window:DrawTab({
    Icon = "sparkles",
    Name = "Auto Utilities"
})

local AutoSellTab = Window:DrawTab({
    Icon = "coins",
    Name = "Auto Sell"
})

Window:DrawCategory({
    Name = "Settings"
})

local SettingsTab = Window:DrawTab({
    Icon = "settings",
    Name = "Settings"
})

local Configs = Window:DrawConfig({
    Name = "Configs",
    Icon = "folder",
    Config = FileWatcher
})
Configs:Init()

-- Game Services Initialization
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Shared = ReplicatedStorage:WaitForChild("Shared")
local Knit = require(Shared:WaitForChild("Packages").Knit)
local Utils = require(Shared:WaitForChild("Utils"))
local Ore = require(Shared:WaitForChild("Data"):WaitForChild("Ore"))

local function getCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function getHumanoidRootPart()
    local char = getCharacter()
    return char:WaitForChild("HumanoidRootPart")
end

local function getHumanoid()
    local char = getCharacter()
    return char:FindFirstChildOfClass("Humanoid") or char:WaitForChild("Humanoid")
end

-- Main Farm Tab Implementation
local OreFarmSection = MainFarmTab:DrawSection({
    Name = "Ore Farming",
    Position = "left"
})

local MobFarmSection = MainFarmTab:DrawSection({
    Name = "Mob Farming",
    Position = "right"
})

-- Ore Farming Configuration
local oreFarm = {
    enabled = false,
    tweenSpeed = 120,
    selectedRockTypes = {},
    selectedOreTypes = {},
    rocksESPEnabled = false,
    pickaxeName = "?",
    pickaxeDamage = 0,
    maxRockTime = 4,
    mineInterval = 0.1,
    scanDistance = 500,
}

-- Build dropdown options from ReplicatedStorage.Assets.Rocks
local function buildRockOptions()
    local assets = ReplicatedStorage:FindFirstChild("Assets")
    local rocksFolder = assets and assets:FindFirstChild("Rocks")
    local options = {}
    if rocksFolder then
        for _, rock in ipairs(rocksFolder:GetChildren()) do
            if rock.Name and rock.Name ~= "" then
                table.insert(options, rock.Name)
            end
        end
    end
    table.sort(options)
    if #options == 0 then
        table.insert(options, "Boulder")
    end
    return options
end

local function buildOreOptions()
    local assets = ReplicatedStorage:FindFirstChild("Assets")
    local oresFolder = assets and assets:FindFirstChild("Ores")
    local options = {}
    if oresFolder then
        for _, ore in ipairs(oresFolder:GetChildren()) do
            if ore.Name and ore.Name ~= "" then
                table.insert(options, ore.Name)
            end
        end
    end
    table.sort(options)
    if #options == 0 then
        table.insert(options, "Any")
    end
    return options
end

local rockOptions = buildRockOptions()
local oreOptions = buildOreOptions()

OreFarmSection:AddSlider({
    Name = "Scan Distance",
    Min = 100,
    Max = 500,
    Round = 0,
    Default = 500,
    Type = "studs",
    Callback = function(value)
        oreFarm.scanDistance = value
    end
})

OreFarmSection:AddSlider({
    Name = "Tween Speed",
    Min = 30,
    Max = 100,
    Round = 0,
    Default = 120,
    Callback = function(value)
        oreFarm.tweenSpeed = value
    end
})

local RockTypeDropdown = OreFarmSection:AddDropdown({
    Name = "Rock Types",
    Values = rockOptions,
    Multi = true,
    Default = {rockOptions[1]},
    Callback = function(opts)
        oreFarm.selectedRockTypes = opts
    end
})

OreFarmSection:AddButton({
    Name = "Refresh Rock Types",
    Callback = function()
        rockOptions = buildRockOptions()
        RockTypeDropdown:SetOptions(rockOptions)
        if not table.find(oreFarm.selectedRockTypes, function(v) return v == rockOptions[1] end) then
            oreFarm.selectedRockTypes = {rockOptions[1]}
            RockTypeDropdown:SetValue(oreFarm.selectedRockTypes)
        end
    end
})

OreFarmSection:AddDropdown({
    Name = "Ore Types",
    Values = oreOptions,
    Multi = true,
    Default = {oreOptions[1]},
    Callback = function(opts)
        oreFarm.selectedOreTypes = opts
    end
})

OreFarmSection:AddSlider({
    Name = "Max Time Per Rock",
    Min = 1,
    Max = 20,
    Round = 0,
    Default = 4,
    Type = "s",
    Callback = function(value)
        oreFarm.maxRockTime = value
    end
})

OreFarmSection:AddSlider({
    Name = "Mine Interval",
    Min = 0.02,
    Max = 0.5,
    Round = 2,
    Default = 0.1,
    Type = "s",
    Callback = function(value)
        oreFarm.mineInterval = value
    end
})

local PickaxeDebugParagraph = OreFarmSection:AddParagraph({
    Title = "Pickaxe Info",
    Content = "Name: ?\nDamage: ?"
})

-- Mob Farming Configuration
local mobFarm = {
    enabled = false,
    selectedMobs = {},
    attackInterval = 0.1,
    safeHealthPercent = 30,
    mobsESPEnabled = false,
}

local function buildMobOptions()
    local assets = ReplicatedStorage:FindFirstChild("Assets")
    local mobsFolder = assets and assets:FindFirstChild("Mobs")
    local options = {}
    if mobsFolder then
        for _, mob in ipairs(mobsFolder:GetChildren()) do
            if mob.Name and mob.Name ~= "" then
                table.insert(options, mob.Name)
            end
        end
    end
    table.sort(options)
    if #options == 0 then
        table.insert(options, "Zombie")
    end
    return options
end

local mobOptions = buildMobOptions()

MobFarmSection:AddDropdown({
    Name = "Mobs to Farm",
    Values = mobOptions,
    Multi = true,
    Default = {mobOptions[1]},
    Callback = function(opts)
        mobFarm.selectedMobs = opts
    end
})

MobFarmSection:AddSlider({
    Name = "Safe HP %",
    Min = 0,
    Max = 100,
    Round = 0,
    Default = 30,
    Type = "%",
    Callback = function(value)
        mobFarm.safeHealthPercent = value
    end
})

-- Auto Farm Toggles
OreFarmSection:AddToggle({
    Name = "Auto Farm Ores",
    Default = false,
    Callback = function(enabled)
        oreFarm.enabled = enabled
        if enabled then
            task.spawn(function()
                local rockBlacklist = {}
                local blacklistCleanupTimer = 0
                while oreFarm.enabled do
                    if tick() - blacklistCleanupTimer > 30 then
                        table.clear(rockBlacklist)
                        blacklistCleanupTimer = tick()
                    end
                    
                    local pick = ensurePickaxeEquipped()
                    if not pick then
                        task.wait(0.1)
                        updatePickaxeInfoFromGui()
                        continue
                    end
                    
                    updatePickaxeInfoFromGui()
                    
                    local rockSet = listToSet(oreFarm.selectedRockTypes)
                    local targetRock = getNearestRock(rockSet, rockBlacklist)
                    if not targetRock then
                        table.clear(rockBlacklist)
                        task.wait(0.5)
                        continue
                    end
                    
                    local core = targetRock.core
                    if core and core:IsA("BasePart") then
                        pcall(function()
                            tweenToPosition(core.Position, oreFarm.tweenSpeed)
                        end)
                    end
                    
                    if not oreFarm.enabled then break end
                    if not targetRock.model or not targetRock.model.Parent then
                        continue
                    end
                    
                    local result = mineRock(targetRock, oreFarm.selectedOreTypes)
                    if result == "switch" then
                        rockBlacklist[targetRock.model] = true
                    end
                end
            end)
        end
    end
})

MobFarmSection:AddToggle({
    Name = "Auto Farm Mobs",
    Default = false,
    Callback = function(enabled)
        mobFarm.enabled = enabled
        if enabled then
            task.spawn(function()
                while mobFarm.enabled do
                    if isLowHealthForMobs() then
                        retreatToSafety()
                        continue
                    end
                    
                    local weapon = ensureWeaponEquipped()
                    if not weapon then
                        wait(0.1)
                        continue
                    end
                    
                    local selectedSet = listToSet(mobFarm.selectedMobs)
                    local target = getNearestMob(selectedSet)
                    if not target then
                        wait(0.2)
                        continue
                    end
                    
                    local mobHrp = target.hrp
                    if mobHrp and mobHrp:IsA("BasePart") then
                        pcall(function()
                            tweenToPosition(mobHrp.Position, oreFarm.tweenSpeed)
                        end)
                    end
                    
                    if isMobDead(target.model) then
                        continue
                    end
                    
                    if not mobFarm.enabled then break end
                    if not target.model or not target.model.Parent then
                        continue
                    end
                    
                    attackMob(target)
                    local interval = tonumber(mobFarm.attackInterval) or 0.1
                    if interval < 0.02 then interval = 0.02 end
                    wait(interval)
                end
            end)
        end
    end
})

-- Rocks ESP with fallbacks
OreFarmSection:AddToggle({
    Name = "Rocks ESP",
    Default = false,
    Callback = function(enabled)
        oreFarm.rocksESPEnabled = enabled
        if not enabled then
            clearRocksESP()
        else
            task.spawn(function()
                while oreFarm.rocksESPEnabled and oreFarm.enabled do
                    updateRocksESP()
                    wait(0.5)
                end
            end)
        end
    end
})

-- Mobs ESP with fallbacks
MobFarmSection:AddToggle({
    Name = "Mobs ESP",
    Default = false,
    Callback = function(enabled)
        mobFarm.mobsESPEnabled = enabled
        if not enabled then
            clearMobsESP()
        else
            task.spawn(function()
                while mobFarm.mobsESPEnabled and mobFarm.enabled do
                    updateMobsESP()
                    wait(0.5)
                end
            end)
        end
    end
})

-- Auto Forge Tab Implementation
local autoForge = {
    enabled = false,
    itemType = "Weapon",
    selectedOres = {},
    totalOresPerForge = 3,
    autoMinigames = true,
    mode = "Above",
    weaponThreshold = 10,
    armorThreshold = 10,
}

local StatusParagraph = AutoForgeTab:AddParagraph({
    Title = "Status",
    Content = "Idle"
})

local function setStatus(text)
    if StatusParagraph then
        StatusParagraph:SetContent(text)
    end
end

AutoForgeTab:AddDropdown({
    Name = "Item Type",
    Values = {"Weapon", "Armor"},
    Multi = false,
    Default = "Weapon",
    Callback = function(opts)
        autoForge.itemType = opts
    end
})

AutoForgeTab:AddDropdown({
    Name = "Ores to Use",
    Values = oreOptions,
    Multi = true,
    Default = {oreOptions[1]},
    Callback = function(opts)
        autoForge.selectedOres = opts
    end
})

AutoForgeTab:AddSlider({
    Name = "Ores Per Forge",
    Min = 3,
    Max = 10,
    Round = 0,
    Default = 3,
    Callback = function(value)
        autoForge.totalOresPerForge = value
    end
})

AutoForgeTab:AddToggle({
    Name = "Auto Complete Minigames",
    Default = true,
    Callback = function(enabled)
        autoForge.autoMinigames = enabled
    end
})

AutoForgeTab:AddToggle({
    Name = "Enable Auto Forge",
    Default = false,
    Callback = function(enabled)
        autoForge.enabled = enabled
        if enabled then
            task.spawn(runAutoForgeLoop)
        end
    end
})

-- Auto Utilities Tab Implementation
local autoPotions = {
    enabled = false,
    selected = {},
}

local autoMovement = {
    alwaysRun = false,
    autoDodge = false,
}

-- Build potion options
local function buildPotionOptions()
    local potFolder = ReplicatedStorage:FindFirstChild("Assets")
    potFolder = potFolder and potFolder:FindFirstChild("Extras") or nil
    potFolder = potFolder and potFolder:FindFirstChild("Potion") or nil
    local names = {}
    if potFolder then
        for _, inst in ipairs(potFolder:GetChildren()) do
            if inst.Name and typeof(inst.Name) == "string" then
                table.insert(names, inst.Name)
            end
        end
    end
    table.sort(names)
    if #names == 0 then
        table.insert(names, "Health Potion")
    end
    return names
end

local potionOptions = buildPotionOptions()

local potionsSection = AutoTab:DrawSection({
    Name = "Auto Potions",
    Position = "left"
})

local movementSection = AutoTab:DrawSection({
    Name = "Movement",
    Position = "right"
})

potionsSection:AddDropdown({
    Name = "Potions to Use",
    Values = potionOptions,
    Multi = true,
    Default = {},
    Callback = function(opts)
        autoPotions.selected = opts
    end
})

potionsSection:AddToggle({
    Name = "Enable Auto Potions",
    Default = false,
    Callback = function(enabled)
        autoPotions.enabled = enabled
        if enabled then
            task.spawn(autoPotionLoop)
        end
    end
})

movementSection:AddToggle({
    Name = "Always Run",
    Default = false,
    Callback = function(enabled)
        autoMovement.alwaysRun = enabled
        if enabled then
            task.spawn(autoMovementLoop)
        end
        if not enabled then
            stopRunCharacter()
        end
    end
})

movementSection:AddToggle({
    Name = "Auto Dodge",
    Default = false,
    Callback = function(enabled)
        autoMovement.autoDodge = enabled
        if enabled then
            task.spawn(autoMovementLoop)
        end
    end
})

-- Auto Sell Tab Implementation
local autoSell = {
    enabled = false,
    selectedOres = {},
    selectedInvItems = {},
    interval = 10,
    sellAmount = 100,
}

local currentInvOptions = {"Click Refresh Inventory"}
local InvDropdown

local function RefreshInventoryList()
    local inv = getInventoryFromUI()
    local options = {}
    for name, _ in pairs(inv) do
        table.insert(options, name)
    end
    table.sort(options)
    if #options == 0 then
        options = {"No items found (Open Stash)"}
    end
    currentInvOptions = options
    if InvDropdown then
        InvDropdown:SetOptions(currentInvOptions)
    end
end

AutoSellTab:AddToggle({
    Name = "Enable Auto Sell",
    Default = false,
    Callback = function(enabled)
        autoSell.enabled = enabled
        if enabled then
            task.spawn(function()
                while autoSell.enabled do
                    performAutoSell()
                    task.wait(autoSell.interval)
                end
            end)
        end
    end
})

AutoSellTab:AddDropdown({
    Name = "Ores to Auto Sell",
    Values = oreOptions,
    Multi = true,
    Default = {},
    Callback = function(opts)
        autoSell.selectedOres = opts
    end
})

AutoSellTab:AddButton({
    Name = "Refresh Inventory",
    Callback = RefreshInventoryList
})

InvDropdown = AutoSellTab:AddDropdown({
    Name = "Inventory Items",
    Values = currentInvOptions,
    Multi = true,
    Default = {},
    Callback = function(opts)
        autoSell.selectedInvItems = opts
    end
})

AutoSellTab:AddSlider({
    Name = "Sell Amount",
    Min = 1,
    Max = 1000,
    Round = 0,
    Default = 100,
    Callback = function(value)
        autoSell.sellAmount = value
    end
})

AutoSellTab:AddSlider({
    Name = "Sell Interval",
    Min = 5,
    Max = 120,
    Round = 0,
    Default = 10,
    Type = "s",
    Callback = function(value)
        autoSell.interval = value
    end
})

-- Settings Tab Implementation
local AntiAFKSection = SettingsTab:DrawSection({
    Name = "Anti-AFK",
    Position = "left"
})

local UISection = SettingsTab:DrawSection({
    Name = "UI Settings",
    Position = "right"
})

-- Anti-AFK system
local antiAfk = {
    enabled = true,
    running = false,
    interval = 60,
    key = Enum.KeyCode.ButtonR3,
    bindName = "SoulsHub_AntiAFK_Sink",
}

local function AA_BindSink()
    pcall(function() game:GetService("ContextActionService"):UnbindAction(antiAfk.bindName) end)
    pcall(function()
        game:GetService("ContextActionService"):BindAction(antiAfk.bindName, function()
            return Enum.ContextActionResult.Sink
        end, false, antiAfk.key)
    end)
end

local function AA_UnbindSink()
    pcall(function() game:GetService("ContextActionService"):UnbindAction(antiAfk.bindName) end)
end

local function AA_Tap()
    pcall(function() 
        game:GetService("VirtualInputManager"):SendKeyEvent(true, antiAfk.key, false, game) 
    end)
    task.wait(0.06)
    pcall(function() 
        game:GetService("VirtualInputManager"):SendKeyEvent(false, antiAfk.key, false, game) 
    end)
end

local function AA_Start()
    if antiAfk.running then return end
    antiAfk.running = true
    AA_BindSink()
    task.spawn(function()
        while antiAfk.enabled do
            AA_Tap()
            local waitFor = (antiAfk.interval or 60) + math.random(-2, 2)
            if waitFor < 10 then waitFor = 10 end
            for _ = 1, waitFor * 10 do
                if not antiAfk.enabled then break end
                task.wait(0.1)
            end
        end
        antiAfk.running = false
        AA_UnbindSink()
    end)
end

AntiAFKSection:AddToggle({
    Name = "Enable Anti-AFK",
    Default = true,
    Callback = function(enabled)
        antiAfk.enabled = enabled
        if enabled then
            AA_Start()
        end
    end
})

AntiAFKSection:AddSlider({
    Name = "AFK Tap Interval",
    Min = 30,
    Max = 180,
    Round = 0,
    Default = 60,
    Type = "s",
    Callback = function(value)
        antiAfk.interval = value
    end
})

-- UI Settings
local ml = UISection:AddColorPicker({
    Name = 'Highlight Color',
    Default = SoulsHub.Colors.Highlight,
    Callback = function(v)
        SoulsHub:ChangeHighlightColor(v)
    end
}).Link:AddOption()

ml:AddToggle({
    Name = "Rainbow",
    Default = false,
    Callback = function(v)
        _G.RAINBOW = v
    end
})

ml:AddSlider({
    Name = "Speed",
    Min = 0.01,
    Max = 1,
    Round = 2,
    Default = 0.1,
    Callback = function(v)
        _G.RAINBOW_SPEED = v
    end
})

task.spawn(function()
    local x = 0
    while true do
        task.wait(_G.RAINBOW_SPEED or 0.1)
        if _G.RAINBOW then
            SoulsHub:ChangeHighlightColor(Color3.fromHSV(x, 1, 1))
            x = x + 2/255
            if x >= 1 then
                x = 0
            end
        end
    end
end)

-- Helper functions with fallbacks (simplified for brevity)
local function listToSet(list)
    local set = {}
    for _, v in ipairs(list) do
        set[tostring(v)] = true
    end
    return set
end

local function ensurePickaxeEquipped()
    local char = getCharacter()
    local hum = getHumanoid()
    for _, t in ipairs(char:GetChildren()) do
        if isPickaxe(t) then
            return t
        end
    end
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, t in ipairs(backpack:GetChildren()) do
            if isPickaxe(t) then
                pcall(function()
                    if hum then
                        hum:EquipTool(t)
                    else
                        t.Parent = char
                    end
                end)
                task.wait(0.1)
                return t
            end
        end
    end
    return nil
end

-- Additional helper functions would be implemented here with proper fallbacks
-- (getNearestRock, mineRock, tweenToPosition, updateRocksESP, etc.)

-- Final draw call
Window:Draw()
