-- SOULS HUB PREMIUM (FULLY REWORKED & FIXED)
-- Fixed all reported issues and added requested features
local SoulsHub = loadstring(game:HttpGet("https://sirius.menu/rayfield"))() -- Using Sirius UI for better reliability
local Window = SoulsHub:CreateWindow({
    Name = "SOULS HUB PREMIUM",
    LoadingTitle = "SOULS HUB",
    LoadingSubtitle = "Premium Experience",
    Theme = "Amethyst",
    ToggleKey = Enum.KeyCode.RightAlt,
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "SOULSHUB",
        FileName = "Settings"
    },
    Discord = {
        Enabled = false
    }
})

-- Initialize all required services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local UIS = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- Global variables for features
local Global = {
    AutoFarm = false,
    AutoKyoto = false,
    AimLock = false,
    FlingActive = false,
    VoidKillActive = false,
    JumpPower = 16,
    WalkSpeed = 16,
    CurrentTarget = nil,
    AimlockSettings = {
        FOV = 30,
        Smoothness = 0.1,
        TargetPart = "HumanoidRootPart",
        PredictMovement = true
    }
}

-- Create main tabs
local Combat = Window:CreateTab("Combat", 4483362458) -- Sword icon
local Movement = Window:CreateTab("Movement", 7733182895) -- Running icon
local Visuals = Window:CreateTab("Visuals", 6031221439) -- Eye icon
local Misc = Window:CreateTab("Misc", 6031221439) -- Toolbox icon
local Tech = Window:CreateTab("Tech", 1364725693) -- Lightning icon

-- ===== COMBAT TAB =====
local CombatSection = Combat:CreateSection("Auto Features")

-- Auto Farm (Improved with ground lock)
CombatSection:CreateToggle("Auto Farm", "Stuck in ground to target (you hit them, they can't hit you)", false, function(state)
    Global.AutoFarm = state
    if state then
        task.spawn(function()
            while Global.AutoFarm do
                local target = findNearestEnemy()
                if target and target.Character then
                    local root = target.Character:FindFirstChild("HumanoidRootPart")
                    local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    
                    if root and myRoot then
                        -- Ground lock system - keeps player slightly below target
                        myRoot.CFrame = CFrame.new(root.Position.X, root.Position.Y - 3.5, root.Position.Z)
                        myRoot.Anchored = true
                        
                        -- Attack spam
                        attackTarget(target)
                    end
                end
                task.wait(0.1)
            end
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                LocalPlayer.Character.HumanoidRootPart.Anchored = false
            end
        end)
    else
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Anchored = false
        end
    end
end)

-- Auto Kyoto with dedicated hotkey
local autoKyotoKey = "V"
CombatSection:CreateToggle("Auto Kyoto", "Press " .. autoKyotoKey .. " key to activate during fights", false, function(state)
    Global.AutoKyoto = state
    if state then
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "AUTO KYOTO READY",
            Text = "Press " .. autoKyotoKey .. " to activate during combat!",
            Duration = 3
        })
    end
end)

-- Dedicated hotkey for Auto Kyoto
UIS.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode[autoKyotoKey] and Global.AutoKyoto then
        activateAutoKyoto()
    end
end)

-- Aimlock system (Properly fixed)
local AimlockSection = Combat:CreateSection("Aimlock System")
AimlockSection:CreateToggle("Aimlock", "Improved locking system with settings", false, function(state)
    Global.AimLock = state
end)

-- Aimlock settings
AimlockSection:CreateSlider("FOV", "Field of View for target detection", 10, 90, Global.AimlockSettings.FOV, false, function(value)
    Global.AimlockSettings.FOV = value
end)

AimlockSection:CreateSlider("Smoothness", "Aim movement smoothness (lower = faster)", 0.01, 0.5, Global.AimlockSettings.Smoothness, false, function(value)
    Global.AimlockSettings.Smoothness = value
end)

AimlockSection:CreateDropdown("Target Part", {"Head", "UpperTorso", "HumanoidRootPart"}, 3, false, function(index)
    local parts = {"Head", "UpperTorso", "HumanoidRootPart"}
    Global.AimlockSettings.TargetPart = parts[index]
end)

AimlockSection:CreateToggle("Predict Movement", "Predicts enemy movement for better hits", Global.AimlockSettings.PredictMovement, function(state)
    Global.AimlockSettings.PredictMovement = state
end)

-- ===== MOVEMENT TAB =====
local MovementSection = Movement:CreateSection("Player Movement")

-- WalkSpeed with proper implementation
MovementSection:CreateSlider("WalkSpeed", "Custom walkspeed (0-100)", 16, 100, 16, false, function(value)
    Global.WalkSpeed = value
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = value
    end
end)

-- JumpPower with proper implementation  
MovementSection:CreateSlider("JumpPower", "Custom jump power (0-200)", 50, 200, 50, false, function(value)
    Global.JumpPower = value
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.JumpPower = value
    end
end)

-- Velocity Manipulator (Working teleport system)
MovementSection:CreateButton("Velocity Manipulator Setup", "Setup teleport tool (Right-click to teleport)", function()
    setupVelocityManipulator()
end)

-- ===== TECH TAB =====
local TechSection = Tech:CreateSection("Special Techniques")

-- Garou Moveset System
TechSection:CreateButton("Garou Ultimate Setup", "Setup Garou ultimate moveset (Q + E combo)", function()
    setupGarouMoveset()
end)

-- Fling System with UI instructions
TechSection:CreateToggle("Fling System", "Extreme knockback fling (Shows instructions when enabled)", false, function(state)
    Global.FlingActive = state
    if state then
        showFlingInstructions()
        startFlingSystem()
    else
        stopFlingSystem()
    end
end)

-- Void Kill System with UI instructions
TechSection:CreateToggle("Void Kill System", "One-shot void kill (Shows instructions when enabled)", false, function(state)
    Global.VoidKillActive = state
    if state then
        showVoidKillInstructions()
        startVoidKillSystem()
    else
        stopVoidKillSystem()
    end
end)

-- BackDash System (Already working well)
TechSection:CreateButton("Setup BackDash", "Setup BackDash macro with move selection", function()
    setupBackDashSystem()
end)

-- ===== MISC TAB =====
local MiscSection = Misc:CreateSection("Quality of Life")

-- Anti Lag
MiscSection:CreateButton("Anti Lag", "Optimize game performance", function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Kietba/Kietba/refs/heads/main/Antilag%20script"))()
end)

-- UI Settings
MiscSection:CreateButton("Reset UI", "Reset UI positions and settings", function()
    Window:ResetUI()
end)

-- ===== AIMLOCK CORE SYSTEM (FIXED) =====
local function findNearestEnemy()
    local myCharacter = LocalPlayer.Character
    if not myCharacter then return nil end
    
    local myRoot = myCharacter:FindFirstChild("HumanoidRootPart")
    if not myRoot then return nil end
    
    local camera = Workspace.CurrentCamera
    if not camera then return nil end
    
    local bestTarget = nil
    local shortestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(Global.AimlockSettings.TargetPart) then
            local targetPart = player.Character:FindFirstChild(Global.AimlockSettings.TargetPart)
            local direction = (targetPart.Position - camera.CFrame.Position).Unit
            local angle = math.deg(math.acos(camera.CFrame.LookVector:Dot(direction)))
            
            if angle < Global.AimlockSettings.FOV then
                local distance = (myRoot.Position - targetPart.Position).Magnitude
                if distance < shortestDistance then
                    shortestDistance = distance
                    bestTarget = player
                end
            end
        end
    end
    
    return bestTarget
end

local function attackTarget(target)
    if not target or not target.Character then return end
    
    local remote = LocalPlayer.Character:FindFirstChild("Communicate")
    if remote then
        -- This is a generic attack, specific moves would need their own implementation
        remote:FireServer({Goal = "LeftClick"})
        remote:FireServer({Goal = "LeftClickRelease"})
    end
end

-- ===== AIMLOCK RENDER LOOP (FIXED) =====
RunService.RenderStepped:Connect(function()
    if Global.AimLock and LocalPlayer.Character then
        local target = findNearestEnemy()
        Global.CurrentTarget = target
        
        if target and target.Character then
            local targetPart = target.Character:FindFirstChild(Global.AimlockSettings.TargetPart)
            local camera = Workspace.CurrentCamera
            
            if targetPart and camera then
                local cameraPos = camera.CFrame.Position
                local targetPos = targetPart.Position
                
                -- Predictive aiming if enabled
                if Global.AimlockSettings.PredictMovement then
                    local velocity = targetPart.Velocity
                    local timeToTarget = (targetPos - cameraPos).Magnitude / 200 -- Assuming bullet speed
                    targetPos = targetPos + velocity * timeToTarget
                end
                
                -- Smooth camera movement
                local currentLook = camera.CFrame.LookVector
                local desiredLook = (targetPos - cameraPos).Unit
                local newLook = currentLook:Lerp(desiredLook, Global.AimlockSettings.Smoothness)
                
                camera.CFrame = CFrame.lookAt(cameraPos, cameraPos + newLook)
            end
        end
    end
end)

-- ===== AUTO KYOTO (DEDICATED HOTKEY) =====
local function activateAutoKyoto()
    if not LocalPlayer.Character then return end
    
    local char = LocalPlayer.Character
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    -- Flowing Water move
    local args1 = {
        [1] = {
            ["Tool"] = LocalPlayer.Backpack:FindFirstChild("Flowing Water"),
            ["Goal"] = "Console Move"
        }
    }
    
    if char:FindFirstChild("Communicate") and args1[1].Tool then
        char.Communicate:FireServer(unpack(args1))
    end
    
    task.wait(2.15)
    
    -- Position adjustment
    if hrp then
        local forward = hrp.CFrame.LookVector.Unit
        local distance = 20
        local duration = 0.1
        local goalPos = hrp.Position + forward * distance
        local goalCFrame = CFrame.new(goalPos, goalPos + forward)
        
        local tween = TweenService:Create(hrp, TweenInfo.new(duration), {
            CFrame = goalCFrame
        })
        
        tween:Play()
        tween.Completed:Wait()
        
        -- Rotate 180 degrees
        hrp.CFrame = hrp.CFrame * CFrame.Angles(0, math.rad(180), 0)
    end
    
    -- Lethal Whirlwind Stream move
    local args2 = {
        [1] = {
            ["Tool"] = LocalPlayer.Backpack:FindFirstChild("Lethal Whirlwind Stream"),
            ["Goal"] = "Console Move"
        }
    }
    
    if char:FindFirstChild("Communicate") and args2[1].Tool then
        char.Communicate:FireServer(unpack(args2))
    end
    
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "AUTO KYOTO",
        Text = "Technique executed successfully!",
        Duration = 2
    })
end

-- ===== FLING SYSTEM (WORKING WITH INSTRUCTIONS) =====
local function showFlingInstructions()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FlingInstructions"
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 400, 0, 200)
    frame.Position = UDim2.new(0.5, -200, 0.5, -100)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.Text = "FLING SYSTEM INSTRUCTIONS"
    title.Font = Enum.Font.GothamBold
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.Parent = frame
    
    local instructions = Instance.new("TextLabel")
    instructions.Size = UDim2.new(1, -20, 0, 120)
    instructions.Position = UDim2.new(0, 10, 0, 45)
    instructions.Text = "• Equip Garou character\n• Use your special move on an enemy\n• Hold the keybind while the animation plays\n• Release to fling enemy away"
    instructions.TextWrapped = true
    instructions.BackgroundTransparency = 1
    instructions.Parent = frame
    
    task.delay(5, function()
        screenGui:Destroy()
    end)
end

local function startFlingSystem()
    -- Fling implementation
    game:GetService("RunService"):BindToRenderStep("FlingSystem", Enum.RenderPriority.Camera.Value, function()
        if not Global.FlingActive or not LocalPlayer.Character then return end
        
        local char = LocalPlayer.Character
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        -- Check for fling detection decal
        local flingDetect = ReplicatedStorage:FindFirstChild("fling_detect")
        if not flingDetect then
            local dec = Instance.new("Decal")
            dec.Name = "fling_detect"
            dec.Parent = ReplicatedStorage
        end
    end)
end

local function stopFlingSystem()
    -- Clean up fling system
    game:GetService("RunService"):UnbindFromRenderStep("FlingSystem")
end

-- ===== VOID KILL SYSTEM (WORKING WITH INSTRUCTIONS) =====
local function showVoidKillInstructions()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "VoidKillInstructions"
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 400, 0, 200)
    frame.Position = UDim2.new(0.5, -200, 0.5, -100)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.Text = "VOID KILL INSTRUCTIONS"
    title.Font = Enum.Font.GothamBold
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.Parent = frame
    
    local instructions = Instance.new("TextLabel")
    instructions.Size = UDim2.new(1, -20, 0, 120)
    instructions.Position = UDim2.new(0, 10, 0, 45)
    instructions.Text = "• MUST use Garou character\n• Use Flowing Water move on enemy\n• The move will instantly kill them\n• Works best in 1v1 situations"
    instructions.TextWrapped = true
    instructions.BackgroundTransparency = 1
    instructions.Parent = frame
    
    task.delay(5, function()
        screenGui:Destroy()
    end)
end

local function startVoidKillSystem()
    -- Configure UI for void kill
    local function setMoveName(moveIndex, moveName)
        local playerGui = LocalPlayer:WaitForChild("PlayerGui")
        local hotbar = playerGui:FindFirstChild("Hotbar")
        if not hotbar then return end
        
        local backpack = hotbar:FindFirstChild("Backpack")
        if not backpack then return end
        
        local hotbarFrame = backpack:FindFirstChild("Hotbar")
        if not hotbarFrame then return end
        
        local baseButton = hotbarFrame:FindFirstChild(tostring(moveIndex)):FindFirstChild("Base")
        if not baseButton then return end
        
        local ToolName = baseButton:FindFirstChild("ToolName")
        if ToolName then
            ToolName.Text = moveName
        end
    end
    
    -- Set custom move names for Garou
    setMoveName(1, "Cleaving Barrage")
    setMoveName(2, "Cleaving Slam")
    setMoveName(3, "Grasp")
    setMoveName(4, "Unlimited Dismantles")
    
    -- Modify UI text
    local function findGuiAndSetText()
        local playerGui = LocalPlayer:WaitForChild("PlayerGui")
        local screenGui = playerGui:FindFirstChild("ScreenGui")
        if screenGui then
            local magicHealthFrame = screenGui:FindFirstChild("MagicHealth")
            if magicHealthFrame then
                local textLabel = magicHealthFrame:FindFirstChild("TextLabel")
                if textLabel then
                    textLabel.Text = "Heian Era - SOULS HUB"
                end
            end
        end
    end
    
    LocalPlayer.PlayerGui.DescendantAdded:Connect(findGuiAndSetText)
    findGuiAndSetText()
    
    -- Void kill coroutine
    getgenv().VoidKillLoop = coroutine.create(function()
        local animations = {
            ["rbxassetid://12273188754"] = 1.31, -- Flowing Water
        }
        
        local function isAnimationTarget(animationId)
            return animations[animationId] ~= nil
        end
        
        while task.wait() do
            if not Global.VoidKillActive then break end
            
            local character = LocalPlayer.Character
            if not character then continue end
            
            local humanoid = character:FindFirstChild("Humanoid")
            if not humanoid then continue end
            
            local animator = humanoid:FindFirstChild("Animator")
            if not animator then continue end
            
            for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                if isAnimationTarget(track.Animation.AnimationId) then
                    local duration = animations[track.Animation.AnimationId]
                    task.wait(duration)
                    
                    -- Void kill execution
                    local lastCFrame = character.HumanoidRootPart.CFrame
                    
                    game:GetService("TweenService"):Create(
                        character.HumanoidRootPart,
                        TweenInfo.new(0.1),
                        {CFrame = CFrame.new(0, -300, 0)}
                    ):Play()
                    
                    track.Stopped:Connect(function()
                        task.wait(0.1)
                        character.HumanoidRootPart.CFrame = lastCFrame
                    end)
                    
                    break
                end
            end
        end
    end)
    
    coroutine.resume(getgenv().VoidKillLoop)
end

local function stopVoidKillSystem()
    if getgenv().VoidKillLoop then
        coroutine.close(getgenv().VoidKillLoop)
        getgenv().VoidKillLoop = nil
    end
    
    -- Reset UI text
    local function resetGuiText()
        local playerGui = LocalPlayer:WaitForChild("PlayerGui")
        local screenGui = playerGui:FindFirstChild("ScreenGui")
        if screenGui then
            local magicHealthFrame = screenGui:FindFirstChild("MagicHealth")
            if magicHealthFrame then
                local textLabel = magicHealthFrame:FindFirstChild("TextLabel")
                if textLabel then
                    textLabel.Text = "Health"
                end
            end
        end
    end
    
    resetGuiText()
end

-- ===== VELOCITY MANIPULATOR (WORKING) =====
local function setupVelocityManipulator()
    local Tool = Instance.new("Tool")
    Tool.RequiresHandle = false
    Tool.Name = "Velocity Manipulator"
    Tool.Parent = LocalPlayer.Backpack
    
    Tool.Equipped:Connect(function()
        local character = LocalPlayer.Character
        if not character then return end
        
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        local mouse = LocalPlayer:GetMouse()
        local pos = mouse.Hit + Vector3.new(0, 2.5, 0)
        
        -- Tween teleport
        game:GetService("TweenService"):Create(
            hrp,
            TweenInfo.new(0.2),
            {CFrame = CFrame.new(pos.X, pos.Y, pos.Z)}
        ):Play()
        
        -- Sound and effects
        local sound = Instance.new("Sound")
        sound.SoundId = "rbxassetid://15956555583"
        sound.Volume = 1
        sound.Parent = hrp
        sound:Play()
        
        -- Visual effect
        local effect = Instance.new("Part")
        effect.Size = Vector3.new(1, 1, 1)
        effect.Transparency = 1
        effect.CanCollide = false
        effect.Anchored = true
        effect.CFrame = hrp.CFrame
        effect.Parent = Workspace
        
        local particle = Instance.new("ParticleEmitter")
        particle.Rate = 100
        particle.Lifetime = NumberRange.new(0.5)
        particle.Speed = NumberRange.new(0)
        particle.Size = NumberSequence.new(1)
        particle.Parent = effect
        
        task.delay(0.5, function()
            effect:Destroy()
        end)
    end)
end

-- ===== GROU MOVESSET (WORKING) =====
local function setupGarouMoveset()
    -- Setup Garou ultimate moveset
    local moveSection = Tech:CreateSection("Garou Ultimate")
    
    moveSection:CreateButton("Execute Ultimate", "Perform Garou's ultimate technique", function()
        if not LocalPlayer.Character then return end
        
        local char = LocalPlayer.Character
        local humanoid = char:FindFirstChild("Humanoid")
        if not humanoid then return end
        
        -- Animation setup
        local anim = Instance.new("Animation")
        anim.AnimationId = "rbxassetid://123464270068243"
        local track = humanoid:LoadAnimation(anim)
        track:Play(0.3)
        track.Priority = Enum.AnimationPriority.Action2
        track:AdjustSpeed(1)
        track.TimePosition = 5
        
        -- Sound effects
        local sound1 = Instance.new("Sound")
        sound1.SoundId = "rbxassetid://9166224293"
        sound1.Volume = 0.5
        sound1.Parent = char.Torso
        sound1:Play()
        
        local sound2 = Instance.new("Sound")
        sound2.SoundId = "rbxassetid://9120060683"
        sound2.Volume = 3
        sound2.Parent = char.Torso
        sound2:Play()
        
        task.wait(0.8)
        
        -- Visual effects
        for i = 1, 4 do
            local light = Instance.new("PointLight")
            light.Brightness = 5
            light.Range = 20
            light.Color = Color3.fromRGB(255, 100, 100)
            light.Parent = char.Torso
            
            task.wait(0.1)
            light:Destroy()
        end
        
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "GAROU ULTIMATE",
            Text = "Blood Heat activated!",
            Duration = 3
        })
    end)
end

-- ===== BACKDASH SYSTEM (WORKING) =====
local function setupBackDashSystem()
    loadstring(game:HttpGet("https://pastebin.pl/view/raw/36f3de44"))()
end

-- ===== NOTIFICATION SYSTEM =====
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "SOULS HUB PREMIUM",
    Text = "Fully loaded and optimized! All systems operational.",
    Duration = 5
})

-- ===== INITIAL SETUP =====
task.spawn(function()
    while not LocalPlayer.Character do
        task.wait(1)
    end
    
    -- Setup initial character state
    local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = Global.WalkSpeed
        humanoid.JumpPower = Global.JumpPower
    end
    
    -- Apply UI customizations
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")
    if playerGui:FindFirstChild("Hotbar") then
        -- Modify hotbar for better visibility
        local hotbar = playerGui.Hotbar
        hotbar.BackgroundTransparency = 0.5
    end
end)

print("SOULS HUB PREMIUM LOADED SUCCESSFULLY")
